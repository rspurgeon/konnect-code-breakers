name: Konnect Sync

on:
  push:
    branches:
      - main
    paths:
      - api/**
      - portal/**
      - konnect/**

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Install kongctl
        run: |
          set -euo pipefail
          repo="Kong/kongctl"
          asset=$(curl -sL "https://api.github.com/repos/${repo}/releases/latest" \
            | jq -r '.assets[] | select(.name | test("linux_amd64.tar.gz$")) | .browser_download_url' \
            | head -n 1)
          if [[ -z "$asset" ]]; then
            echo "Unable to find kongctl release asset." >&2
            exit 1
          fi
          tmp_dir=$(mktemp -d)
          curl -sL "$asset" -o "$tmp_dir/kongctl.tar.gz"
          tar -xzf "$tmp_dir/kongctl.tar.gz" -C "$tmp_dir"
          bin_path=$(find "$tmp_dir" -type f -name kongctl | head -n 1)
          if [[ -z "$bin_path" ]]; then
            echo "kongctl binary not found in release archive." >&2
            exit 1
          fi
          sudo install "$bin_path" /usr/local/bin/kongctl
          kongctl version

      - name: Install deck
        run: |
          set -euo pipefail
          repo="Kong/deck"
          asset=$(curl -sL "https://api.github.com/repos/${repo}/releases/latest" \
            | jq -r '.assets[] | select(.name | test("linux_amd64.tar.gz$")) | .browser_download_url' \
            | head -n 1)
          if [[ -z "$asset" ]]; then
            echo "Unable to find deck release asset." >&2
            exit 1
          fi
          tmp_dir=$(mktemp -d)
          curl -sL "$asset" -o "$tmp_dir/deck.tar.gz"
          tar -xzf "$tmp_dir/deck.tar.gz" -C "$tmp_dir"
          bin_path=$(find "$tmp_dir" -type f -name deck | head -n 1)
          if [[ -z "$bin_path" ]]; then
            echo "deck binary not found in release archive." >&2
            exit 1
          fi
          sudo install "$bin_path" /usr/local/bin/deck
          deck version

      - name: Sync Konnect resources
        env:
          KONNECT_TOKEN: ${{ secrets.KONNECT_TOKEN }}
          KONNECT_REGION: ${{ secrets.KONNECT_REGION }}
        run: ./scripts/konnect-sync.sh
